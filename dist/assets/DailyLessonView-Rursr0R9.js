import{a as Ue,D as Be}from"./DailyLessonCalendar-BfP80PJ-.js";import{_ as fe,a as F,L as q,c as je,D as ze}from"./school-service-BlitUF5l.js";import{D as G,_ as Oe,a as Pe,v as He}from"./v4-DOMLpR64.js";import{d as oe,A as ne,B as se,q as H,b as i,e as y,c as L,s as Fe,w as t,f as n,r as S,k as A,t as V,u as m,l as f,g as le,F as ae,j as P,m as h,E as qe,n as Z,a as Ge,o as Je,G as he,y as Ke,h as me,i as J,T as ee,L as Qe}from"./index-DqQs06DF.js";import{T as $,L as T,y as te,l as We}from"./schedule-x-vue-BELKaWgn.js";import"./index.esm-B6FxmsNf.js";import"./school-repository-mPHwUDC0.js";const Xe=oe({__name:"VSelectStudents",props:ne({allStudents:{default:()=>[]}},{modelValue:{default:[]},modelModifiers:{}}),emits:["update:modelValue"],setup(D){const M=D,b=se(D,"modelValue"),u=H(()=>b.value.length===M.allStudents.length),w=H(()=>b.value.length>0);function o(){u.value?b.value=[]:b.value=M.allStudents.slice()}return(v,k)=>{const c=i("v-checkbox-btn"),a=i("v-list-item"),C=i("v-divider"),N=i("v-select");return y(),L(N,{modelValue:b.value,"onUpdate:modelValue":k[0]||(k[0]=_=>b.value=_),items:v.allStudents,label:"Studenti","item-title":"name","item-value":"id","return-object":!0,multiple:"","no-data-text":"Nessuno studente disponibile per questa scuola"},Fe({_:2},[v.allStudents.length>1?{name:"prepend-item",fn:t(()=>[n(a,{title:"Seleziona tutti",onClick:o},{prepend:t(()=>[n(c,{color:w.value?"indigo-darken-4":void 0,indeterminate:w.value&&!u.value,"model-value":u.value},null,8,["color","indeterminate","model-value"])]),_:1}),n(C,{class:"mt-2"})]),key:"0"}:void 0]),1032,["modelValue","items"])}}}),Ye={class:"bg-primary"},Ze=oe({__name:"LessonItem",props:ne({onDeleteLessonItem:{type:Function},updateLessonTime:{type:Function}},{item:{required:!0},itemModifiers:{},select:{},selectModifiers:{}}),emits:ne(["present","absent","reset","cancel","updateLessonTime","notes","deleteStudent"],["update:item","update:select"]),setup(D,{emit:M}){const b=D,u=se(D,"item"),w=se(D,"select"),o=M,v=S(!1);async function k(c){await b.updateLessonTime(c)&&(v.value=!1)}return(c,a)=>{const C=i("v-checkbox"),N=i("v-card-title"),_=i("v-btn"),x=i("v-dialog"),R=i("v-icon"),U=i("v-card-text"),z=i("v-card");return y(),L(z,{elevation:"3"},{default:t(()=>[n(N,null,{default:t(()=>[n(C,{modelValue:w.value,"onUpdate:modelValue":a[0]||(a[0]=E=>w.value=E),value:u.value.id,multiple:""},{label:t(()=>[A("span",null,[A("b",null,V(m($).fromITime(u.value.startTime).format())+" - "+V(m($).fromITime(u.value.endTime).format()),1),a[7]||(a[7]=f(" Â  ")),A("i",null,V(u.value.name)+" "+V(u.value.surname),1)])]),_:1},8,["modelValue","value"])]),_:1}),n(U,null,{default:t(()=>{var E;return[!u.value.recovery||u.value.recovery.ref=="original"?(y(),le(ae,{key:0},[u.value.status!=m(T).PRESENT&&u.value.status!=m(T).CANCELLED?(y(),L(_,{key:0,class:"ma-1",onClick:a[1]||(a[1]=g=>o("present"))},{default:t(()=>a[8]||(a[8]=[f("presente")])),_:1})):P("",!0),u.value.status!=m(T).ABSENT&&u.value.status!=m(T).CANCELLED?(y(),L(_,{key:1,class:"ma-1",onClick:a[2]||(a[2]=g=>o("absent"))},{default:t(()=>a[9]||(a[9]=[f("assente")])),_:1})):P("",!0),u.value.status!=m(T).CANCELLED?(y(),L(_,{key:2,class:"ma-1",onClick:a[3]||(a[3]=g=>o("cancel"))},{default:t(()=>a[10]||(a[10]=[f("cancella")])),_:1})):P("",!0),u.value.status!=m(T).NONE?(y(),L(_,{key:3,class:"ma-1",onClick:a[4]||(a[4]=g=>o("reset"))},{default:t(()=>a[11]||(a[11]=[f("reset")])),_:1})):P("",!0),n(x,{modelValue:v.value,"onUpdate:modelValue":a[5]||(a[5]=g=>v.value=g),transition:"dialog-bottom-transition",fullscreen:""},{activator:t(({props:g})=>[n(_,h({class:"ma-1"},g),{default:t(()=>a[12]||(a[12]=[f("modifica orario")])),_:2},1040)]),default:t(({isActive:g})=>[A("div",Ye,[A("p",null,V(u.value)+" "+V(m($).fromITime(u.value.startTime).format())+" "+V(u.value.endTime),1),n(Ue,{onClose:ue=>g.value=!1,onSave:k,startTime:m($).fromITime(u.value.startTime).format(),endTime:m($).fromITime(u.value.endTime).format(),minutesOfLesson:u.value.minutesLessonDuration},null,8,["onClose","startTime","endTime","minutesOfLesson"])])]),_:1},8,["modelValue"]),((E=u.value.recovery)==null?void 0:E.ref)=="original"?(y(),L(_,{key:4,class:"ma-1",to:`/lesson/${u.value.recovery.lessonRef.dailyLessonId}`},{prepend:t(()=>[n(R,null,{default:t(()=>a[13]||(a[13]=[f("mdi-eye-arrow-left-outline")])),_:1})]),default:t(()=>[a[14]||(a[14]=f(" origine"))]),_:1},8,["to"])):P("",!0)],64)):(y(),L(_,{key:1,class:"ma-1",to:`/lesson/${u.value.recovery.lessonRef.dailyLessonId}`},{prepend:t(()=>[n(R,null,{default:t(()=>a[15]||(a[15]=[f("mdi-eye-arrow-right-outline")])),_:1})]),default:t(()=>[a[16]||(a[16]=f("recupero"))]),_:1},8,["to"])),n(_,{class:"ma-1",onClick:a[6]||(a[6]=g=>o("notes"))},{default:t(()=>a[17]||(a[17]=[f("note")])),_:1}),n(fe,{name:`${u.value.name} ${u.value.surname}`,objName:"Studente",onDelete:c.onDeleteLessonItem},{activator:t(({props:g})=>[n(_,h({color:"error"},g),{default:t(()=>a[18]||(a[18]=[f("elimina")])),_:2},1040)]),_:1},8,["name","onDelete"])]}),_:1})]),_:1})}}}),et={class:"text-h5 text-center"},dt=oe({__name:"DailyLessonView",setup(D){const M=he(),b=Ke(),u=H(()=>M.params.id),w=G.instance.observe(u),o=qe(w),v=S([]),k=S(!1),c=S([]),a=S([]),C=S([]),N=S(!1),_=S(!1),x=S(!1),R=S(!1),U=S(!1),z=S(!0),E=S(0),g=H(()=>v.value.length!=0),ue=H(()=>N.value||!o.value||z.value);let ie;Z(o,()=>we()),Z(w,()=>z.value=!0),Z(v,()=>{v.value.length==0&&(k.value=!1)});function pe(s){return s.trial?"yellow":s.recovery&&s.recovery.ref=="recovery"?"blue":We[s.status]}async function de(s){O();const e=v.value.map(l=>c.value.find(r=>r.id==l)).filter(l=>!!l);e.push(s),e.forEach(l=>l.status=T.PRESENT),v.value=[],await B(),await F.instance.updateRecovery(q.SET_PRESENT,o.value.schoolId,...e.map(l=>({...l,dailyLessonId:o.value.id})))}async function re(s){O();const e=v.value.map(l=>c.value.find(r=>r.id==l)).filter(l=>!!l);e.push(s),e.forEach(l=>l.status=T.ABSENT),v.value=[],await B(),await F.instance.updateRecovery(q.SET_ABSENT,o.value.schoolId,...e.map(l=>({...l,dailyLessonId:o.value.id})))}async function ye(s){s&&(O(),s.status=T.CANCELLED,await B(),await F.instance.updateRecovery(q.CANCEL,o.value.schoolId,{...s,dailyLessonId:o.value.id}))}async function _e(s){s&&(O(),s.status=T.NONE,await B(),await F.instance.updateRecovery(q.RESET,o.value.schoolId,{...s,dailyLessonId:o.value.id}))}async function ge(s,e){var p,j;const l=(p=$.fromHHMM(e.startTime))==null?void 0:p.toITime(),r=(j=$.fromHHMM(e.endTime))==null?void 0:j.toITime();return l==null||r==null?!1:(O(),s.startTime=l,s.endTime=r,c.value.sort((Q,W)=>Q.startTime-W.startTime),await B(),!0)}function tt(s){}function Le(){k.value?v.value=[]:v.value=[...c.value.map(s=>s.id)]}let K;function O(){K=JSON.stringify(c.value)}function Se(){K!=null&&(c.value=JSON.parse(K))}async function Te(){if(o.value)try{_.value=!0;const s=o.value.lessons.map(l=>l.studentId),e=await Pe.instance.getStudentsOfSchool(o.value.schoolId);a.value=e.filter(l=>!s.includes(l.id)),C.value=[]}catch(s){J.warn("Impossibile caricare gli studenti..."),console.log(s)}finally{_.value=!1}}async function be(){R.value=!0;const s={...o.value};C.value.forEach(e=>{var r,p;const l=((r=s.lessons)==null?void 0:r.length)==0?0:s.lessons[s.lessons.length-1].endTime;(p=s.lessons)==null||p.push({lessonId:He(),status:T.NONE,studentId:e.id,startTime:l,endTime:l+e.minutesLessonDuration*60,createdAt:ee.now(),updatedAt:ee.now()})});try{await G.instance.save(s,s.id),J.success("Studenti aggiunti!"),U.value=!1,console.log("Document (daily lessons) update with ID: ",s.id)}catch{J.warning("Impossibile aggiungere gli studenti alla lezione giornaliera")}finally{R.value=!1}}async function Ie(){if(!o.value)return!1;try{return await G.instance.delete(o.value.id),b.go(-1),!0}catch{return!1}}async function ke(s){if(!o.value)return!1;try{return await ze.instance.deleteStudentLesson(s,o.value)}catch{return!1}}async function we(){if(z.value=!1,!o.value)return;const s=c.value.map(r=>r.studentId),e=o.value.lessons.map(r=>r.studentId);Qe(s,e)&&ie==o.value.id||(N.value=!0,ie=o.value.id,c.value=await je.instance.getStudentLesson(o.value,e),N.value=!1)}async function B(){x.value=!0;const s=Ce();if(s===void 0){x.value=!1;return}try{await G.instance.save(s,s.id),J.success("Modifiche salvate",{autoClose:1e3}),x.value=!1}catch(e){console.error("Error adding document (dailyLesson): ",e),x.value=!1,Se()}}function Ce(){const s=o.value;if(s===void 0)return;const e=[];return s.lessons.forEach(l=>{const r=c.value.find(j=>j.id==l.studentId);if(r===void 0)return;const p={lessonId:l.lessonId,createdAt:l.createdAt,studentId:l.studentId,startTime:r.startTime,endTime:r.endTime,status:r.status,updatedAt:ee.now()};l.recovery&&(p.recovery=l.recovery),l.trial&&(p.trial=l.trial),e.push(p)}),{date:s.date,id:s.id,lessons:e.sort((l,r)=>l.startTime-r.startTime),schoolId:s.schoolId}}return Ge(()=>{}),Je(async()=>{window.scrollTo(0,0)}),(s,e)=>{const l=i("v-col"),r=i("v-row"),p=i("v-btn"),j=i("v-card-text"),Q=i("v-spacer"),W=i("v-card-actions"),Ee=i("v-card"),Ve=i("v-dialog"),De=i("v-checkbox"),ce=i("v-icon"),Ne=i("v-btn-toggle"),xe=i("v-timeline-item"),Ae=i("v-timeline"),$e=i("v-slide-x-transition"),X=i("v-container"),Me=i("v-progress-circular"),Re=i("v-overlay"),Y=i("v-skeleton-loader");return m(o)&&!ue.value?(y(),L(X,{key:0,fluid:""},{default:t(()=>[n(r,{class:"justify-center align-center mb-6"},{default:t(()=>[n(l,{cols:"auto"},{default:t(()=>[n(Oe)]),_:1}),n(l,null,{default:t(()=>[A("p",et,[e[7]||(e[7]=f("Lezioni del ")),A("b",null,V(m(te).fromIyyyyMMdd(m(o).date).format()),1)])]),_:1})]),_:1}),n(r,null,{default:t(()=>[n(l,null,{default:t(()=>[n(p,{onClick:de,disabled:!g.value},{default:t(()=>e[8]||(e[8]=[f("presenti")])),_:1},8,["disabled"])]),_:1}),n(l,null,{default:t(()=>[n(p,{onClick:re,disabled:!g.value},{default:t(()=>e[9]||(e[9]=[f("assenti")])),_:1},8,["disabled"])]),_:1}),n(l,null,{default:t(()=>[n(Ve,{modelValue:U.value,"onUpdate:modelValue":e[2]||(e[2]=d=>U.value=d),transition:"dialog-bottom-transition","max-width":"500",persistent:""},{activator:t(({props:d})=>[n(p,h({onClick:Te},d),{default:t(()=>e[10]||(e[10]=[f("Aggiungi studente")])),_:2},1040)]),default:t(()=>[n(Ee,{title:"Tutti gli studenti della scuola",loading:_.value},{default:t(()=>[n(j,null,{default:t(()=>[n(Xe,{modelValue:C.value,"onUpdate:modelValue":e[0]||(e[0]=d=>C.value=d),"all-students":a.value},null,8,["modelValue","all-students"])]),_:1}),n(W,null,{default:t(()=>[n(p,{text:"Annulla",onClick:e[1]||(e[1]=d=>U.value=!1)}),n(Q),n(p,{color:"primary",text:"Salva",onClick:be,loading:R.value},null,8,["loading"])]),_:1})]),_:1},8,["loading"])]),_:1},8,["modelValue"])]),_:1}),n(l,null,{default:t(()=>[n(De,{modelValue:k.value,"onUpdate:modelValue":e[3]||(e[3]=d=>k.value=d),indeterminate:v.value.length!=0&&v.value.length!=c.value.length,onClick:Le},null,8,["modelValue","indeterminate"])]),_:1}),n(l,null,{default:t(()=>[n(fe,{name:m(te).fromIyyyyMMdd(m(o).date).format(),objName:"Lezione Giornaliera",onDelete:async()=>await Ie()},{activator:t(({props:d})=>[n(p,h({color:"error"},d),{default:t(()=>e[11]||(e[11]=[f("elimina lezione")])),_:2},1040)]),_:1},8,["name","onDelete"])]),_:1}),n(l,null,{default:t(()=>[n(Ne,{modelValue:E.value,"onUpdate:modelValue":e[4]||(e[4]=d=>E.value=d),mandatory:"",shaped:""},{default:t(()=>[n(p,null,{default:t(()=>[n(ce,null,{default:t(()=>e[12]||(e[12]=[f("mdi-timeline-text-outline")])),_:1})]),_:1}),n(p,null,{default:t(()=>[n(ce,null,{default:t(()=>e[13]||(e[13]=[f("mdi-calendar-week-begin-outline")])),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),n(X,{fluid:""},{default:t(()=>[n($e,{"leave-absolute":""},{default:t(()=>[E.value==1?(y(),L(Be,{key:0,date:m(te).fromIyyyyMMdd(m(o).date),modelValue:c.value,"onUpdate:modelValue":e[5]||(e[5]=d=>c.value=d),editable:"",sort:"",onEdit:B},null,8,["date","modelValue"])):(y(),L(Ae,{key:1,side:"end","truncate-line":"both"},{default:t(()=>[(y(!0),le(ae,null,me(c.value,(d,ve)=>(y(),L(xe,{key:d.id+m(o).id,"dot-color":pe(d),size:"small"},{default:t(()=>[(y(),L(Ze,{key:d.id+m(o).id,item:c.value[ve],"onUpdate:item":I=>c.value[ve]=I,select:v.value,"onUpdate:select":e[6]||(e[6]=I=>v.value=I),onPresent:I=>de(d),onAbsent:I=>re(d),onCancel:I=>ye(d),onReset:I=>_e(d),updateLessonTime:async I=>await ge(d,I),onNotes:I=>void 0,onDeleteLessonItem:async()=>await ke(d)},null,8,["item","onUpdate:item","select","onPresent","onAbsent","onCancel","onReset","updateLessonTime","onNotes","onDeleteLessonItem"]))]),_:2},1032,["dot-color"]))),128))]),_:1}))]),_:1})]),_:1}),n(Re,{"model-value":x.value,class:"align-center justify-center"},{default:t(()=>[n(Me,{color:"primary",size:"64",indeterminate:""})]),_:1},8,["model-value"])]),_:1})):(y(),L(X,{key:1,fluid:""},{default:t(()=>[n(Y,{class:"mx-auto",type:"heading"}),n(Y,{class:"mx-auto justify-center",type:"chip, chip, chip, chip, chip, chip, chip"}),(y(),le(ae,null,me(3,d=>n(Y,{key:d,class:"mx-auto justify-center mt-4","max-width":"75%",elevation:"3",type:"sentences, chip, chip, chip, chip"})),64))]),_:1}))}}});export{dt as default};
