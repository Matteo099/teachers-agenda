import{_ as ze,D as Oe}from"./DailyLessonCalendar-DC6ciTLI.js";import{_ as _e}from"./DeleteDialog.vue_vue_type_script_setup_true_lang-DHWn9YE8.js";import{_ as He}from"./BackButton.vue_vue_type_script_setup_true_lang-C8dZMgDG.js";import{d as de,A as se,B as oe,p as J,b as i,e as p,c as L,s as Pe,w as t,f as a,r as g,k as D,t as V,u as c,l as v,g as ue,F as ie,j as F,m as Y,E as he,n as ae,a as Fe,o as qe,H as Je,y as Ge,h as ye,i as q,T as K,M as Ke}from"./index-DjUe38IL.js";import{T as U,L as I,y as le,l as Qe}from"./model-CTcth0Ot.js";import{g as Q,c as W,L as X,S as We,v as Xe,h as Ye,f as Ze,D as et}from"./school-service-BKRy073a.js";import{S as tt}from"./school-repository-DwlukrFv.js";import"./schedule-x-vue-dDfllttq.js";import"./index.esm-Bofgu8vL.js";import"./_plugin-vue_export-helper-DlAUqK2U.js";const nt=de({__name:"VSelectStudents",props:se({allStudents:{default:()=>[]}},{modelValue:{default:[]},modelModifiers:{}}),emits:["update:modelValue"],setup(A){const B=A,w=oe(A,"modelValue"),u=J(()=>w.value.length===B.allStudents.length),N=J(()=>w.value.length>0);function s(){u.value?w.value=[]:w.value=B.allStudents.slice()}return(T,m)=>{const k=i("v-checkbox-btn"),n=i("v-list-item"),j=i("v-divider"),x=i("v-select");return p(),L(x,{modelValue:w.value,"onUpdate:modelValue":m[0]||(m[0]=_=>w.value=_),items:T.allStudents,label:"Studenti","item-title":"name","item-value":"id","return-object":!0,multiple:"","no-data-text":"Nessuno studente disponibile per questa scuola"},Pe({_:2},[T.allStudents.length>1?{name:"prepend-item",fn:t(()=>[a(n,{title:"Seleziona tutti",onClick:s},{prepend:t(()=>[a(k,{color:N.value?"indigo-darken-4":void 0,indeterminate:N.value&&!u.value,"model-value":u.value},null,8,["color","indeterminate","model-value"])]),_:1}),a(j,{class:"mt-2"})]),key:"0"}:void 0]),1032,["modelValue","items"])}}}),at={class:"bg-primary"},lt=de({__name:"LessonItem",props:se({onDeleteLessonItem:{type:Function},updateLessonTime:{type:Function}},{item:{required:!0},itemModifiers:{},select:{},selectModifiers:{}}),emits:se(["present","absent","reset","cancel","updateLessonTime","notes","deleteStudent"],["update:item","update:select"]),setup(A,{emit:B}){const w=A,u=oe(A,"item"),N=oe(A,"select"),s=B,T=g(!1);async function m(k){await w.updateLessonTime(k)&&(T.value=!1)}return(k,n)=>{const j=i("v-checkbox"),x=i("v-card-title"),_=i("v-btn"),O=i("v-dialog"),z=i("v-icon"),$=i("v-card-text"),H=i("v-card");return p(),L(H,{elevation:"3"},{default:t(()=>[a(x,null,{default:t(()=>[a(j,{modelValue:N.value,"onUpdate:modelValue":n[0]||(n[0]=E=>N.value=E),value:u.value.id,multiple:""},{label:t(()=>[D("span",null,[D("b",null,V(c(U).fromITime(u.value.startTime).format())+" - "+V(c(U).fromITime(u.value.endTime).format()),1),n[7]||(n[7]=v("   ")),D("i",null,V(u.value.name)+" "+V(u.value.surname),1)])]),_:1},8,["modelValue","value"])]),_:1}),a($,null,{default:t(()=>{var E;return[!u.value.recovery||u.value.recovery.ref=="original"?(p(),ue(ie,{key:0},[u.value.status!=c(I).PRESENT&&u.value.status!=c(I).CANCELLED?(p(),L(_,{key:0,class:"ma-1",onClick:n[1]||(n[1]=y=>s("present"))},{default:t(()=>n[8]||(n[8]=[v("presente")])),_:1})):F("",!0),u.value.status!=c(I).ABSENT&&u.value.status!=c(I).CANCELLED?(p(),L(_,{key:1,class:"ma-1",onClick:n[2]||(n[2]=y=>s("absent"))},{default:t(()=>n[9]||(n[9]=[v("assente")])),_:1})):F("",!0),u.value.status!=c(I).CANCELLED?(p(),L(_,{key:2,class:"ma-1",onClick:n[3]||(n[3]=y=>s("cancel"))},{default:t(()=>n[10]||(n[10]=[v("cancella")])),_:1})):F("",!0),u.value.status!=c(I).NONE?(p(),L(_,{key:3,class:"ma-1",onClick:n[4]||(n[4]=y=>s("reset"))},{default:t(()=>n[11]||(n[11]=[v("reset")])),_:1})):F("",!0),a(O,{modelValue:T.value,"onUpdate:modelValue":n[5]||(n[5]=y=>T.value=y),transition:"dialog-bottom-transition",fullscreen:""},{activator:t(({props:y})=>[a(_,Y({class:"ma-1"},y),{default:t(()=>n[12]||(n[12]=[v("modifica orario")])),_:2},1040)]),default:t(({isActive:y})=>[D("div",at,[D("p",null,V(u.value)+" "+V(c(U).fromITime(u.value.startTime).format())+" "+V(u.value.endTime),1),a(ze,{onClose:G=>y.value=!1,onSave:m,startTime:c(U).fromITime(u.value.startTime).format(),endTime:c(U).fromITime(u.value.endTime).format(),minutesOfLesson:u.value.minutesLessonDuration},null,8,["onClose","startTime","endTime","minutesOfLesson"])])]),_:1},8,["modelValue"]),((E=u.value.recovery)==null?void 0:E.ref)=="original"?(p(),L(_,{key:4,class:"ma-1",to:`/lesson/${u.value.recovery.lessonRef.dailyLessonId}`},{prepend:t(()=>[a(z,null,{default:t(()=>n[13]||(n[13]=[v("mdi-eye-arrow-left-outline")])),_:1})]),default:t(()=>[n[14]||(n[14]=v(" origine"))]),_:1},8,["to"])):F("",!0)],64)):(p(),L(_,{key:1,class:"ma-1",to:`/lesson/${u.value.recovery.lessonRef.dailyLessonId}`},{prepend:t(()=>[a(z,null,{default:t(()=>n[15]||(n[15]=[v("mdi-eye-arrow-right-outline")])),_:1})]),default:t(()=>[n[16]||(n[16]=v("recupero"))]),_:1},8,["to"])),a(_,{class:"ma-1",onClick:n[6]||(n[6]=y=>s("notes"))},{default:t(()=>n[17]||(n[17]=[v("note")])),_:1}),a(_e,{name:`${u.value.name} ${u.value.surname}`,objName:"Studente",onDelete:k.onDeleteLessonItem},{activator:t(({props:y})=>[a(_,Y({color:"error"},y),{default:t(()=>n[18]||(n[18]=[v("elimina")])),_:2},1040)]),_:1},8,["name","onDelete"])]}),_:1})]),_:1})}}}),st={class:"text-h5 text-center"},ot={class:"text-subtitle"},gt=de({__name:"DailyLessonView",setup(A){const B=Je(),w=Ge(),u=J(()=>B.params.id),N=Q.instance.observe(u),s=he(N),T=g(),m=g([]),k=g(!1),n=g([]),j=g([]),x=g([]),_=g(!1),O=g(!1),z=g(!1),$=g(!1),H=g(!1),E=g(!1),y=g(!0),G=g(0),re=J(()=>m.value.length!=0),ge=J(()=>_.value||O.value||!s.value||y.value);let ce;ae(s,()=>De()),ae(N,()=>y.value=!0),ae(m,()=>{m.value.length==0&&(k.value=!1)});function Se(l){return l.trial?"yellow":l.recovery&&l.recovery.ref=="recovery"?"blue":Qe[l.status]}async function ve(l){P();const e=m.value.map(o=>n.value.find(r=>r.id==o)).filter(o=>!!o);e.push(l),e.forEach(o=>o.status=I.PRESENT),m.value=[],await M(),await W.instance.updateRecovery(X.SET_PRESENT,s.value.schoolId,...e.map(o=>({...o,dailyLessonId:s.value.id})))}async function me(l){P();const e=m.value.map(o=>n.value.find(r=>r.id==o)).filter(o=>!!o);e.push(l),e.forEach(o=>o.status=I.ABSENT),m.value=[],await M(),await W.instance.updateRecovery(X.SET_ABSENT,s.value.schoolId,...e.map(o=>({...o,dailyLessonId:s.value.id})))}async function Le(l){l&&(P(),l.status=I.CANCELLED,await M(),await W.instance.updateRecovery(X.CANCEL,s.value.schoolId,{...l,dailyLessonId:s.value.id}))}async function Te(l){l&&(P(),l.status=I.NONE,await M(),await W.instance.updateRecovery(X.RESET,s.value.schoolId,{...l,dailyLessonId:s.value.id}))}async function be(l,e){var f,R;const o=(f=U.fromHHMM(e.startTime))==null?void 0:f.toITime(),r=(R=U.fromHHMM(e.endTime))==null?void 0:R.toITime();return o==null||r==null?!1:(P(),l.startTime=o,l.endTime=r,n.value.sort((S,b)=>S.startTime-b.startTime),await M(),!0)}function ut(l){}function Ie(){k.value?m.value=[]:m.value=[...n.value.map(l=>l.id)]}let Z;function P(){Z=JSON.stringify(n.value)}function we(){Z!=null&&(n.value=JSON.parse(Z))}async function ke(){if(s.value)try{z.value=!0;const l=s.value.lessons.map(o=>o.studentId),e=await We.instance.getStudentsOfSchool(s.value.schoolId);j.value=e.filter(o=>!l.includes(o.id)),x.value=[]}catch(l){q.warn("Impossibile caricare gli studenti..."),console.log(l)}finally{z.value=!1}}async function Ce(){H.value=!0;const l={...s.value};x.value.forEach(e=>{var r,f;const o=((r=l.lessons)==null?void 0:r.length)==0?0:l.lessons[l.lessons.length-1].endTime;(f=l.lessons)==null||f.push({lessonId:Xe(),status:I.NONE,studentId:e.id,startTime:o,endTime:o+e.minutesLessonDuration*60,createdAt:K.now(),updatedAt:K.now()})});try{await Q.instance.save(l,l.id),q.success("Studenti aggiunti!"),E.value=!1,console.log("Document (daily lessons) update with ID: ",l.id)}catch{q.warning("Impossibile aggiungere gli studenti alla lezione giornaliera")}finally{H.value=!1}}async function Ee(){if(!s.value)return!1;try{return await Q.instance.delete(s.value.id),w.go(-1),!0}catch{return!1}}async function Ve(l){if(!s.value)return!1;try{return await et.instance.deleteStudentLesson(l,s.value)}catch{return!1}}async function De(){if(y.value=!1,!s.value)return;T.value||(O.value=!0,T.value=await tt.instance.get(s.value.schoolId),O.value=!1);const l=n.value.map(r=>r.studentId),e=s.value.lessons.map(r=>r.studentId);Ke(l,e)&&ce==s.value.id||(_.value=!0,ce=s.value.id,n.value=await Ye.instance.getStudentLesson(s.value,e),Ne(),_.value=!1)}async function M(){$.value=!0;const l=xe();if(l===void 0){$.value=!1;return}try{await Q.instance.save(l,l.id),q.success("Modifiche salvate",{autoClose:1e3}),$.value=!1}catch(e){console.error("Error adding document (dailyLesson): ",e),$.value=!1,we()}}function Ne(){var l,e;((l=s.value)==null?void 0:l.salaryStrategy)!=((e=T.value)==null?void 0:e.salaryStrategy)&&(q.info("Aggiornamento dello stipendio giornaliero in corso..."),M())}function xe(){var f,R;const l=s.value;if(l===void 0)return;const e=[];let o=0;l.lessons.forEach(S=>{const b=n.value.find(ee=>ee.id==S.studentId);if(b===void 0)return;const h={lessonId:S.lessonId,createdAt:S.createdAt,studentId:S.studentId,startTime:b.startTime,endTime:b.endTime,status:b.status,updatedAt:K.now()};S.recovery&&(h.recovery=S.recovery),S.trial&&(h.trial=S.trial),e.push(h),o+=Ze.instance.computeSalaryByStudentLesson(T.value,b)});const r={date:l.date,id:l.id,lessons:e.sort((S,b)=>S.startTime-b.startTime),schoolId:l.schoolId,lastSalaryUpdate:K.now(),salary:o};return((f=T.value)==null?void 0:f.salaryStrategy)!=null&&(r.salaryStrategy=(R=T.value)==null?void 0:R.salaryStrategy),r}return Fe(()=>{}),qe(async()=>{window.scrollTo(0,0)}),(l,e)=>{const o=i("v-col"),r=i("v-row"),f=i("v-btn"),R=i("v-card-text"),S=i("v-spacer"),b=i("v-card-actions"),h=i("v-card"),ee=i("v-dialog"),Ae=i("v-checkbox"),fe=i("v-icon"),$e=i("v-btn-toggle"),Me=i("v-timeline-item"),Re=i("v-timeline"),Ue=i("v-slide-x-transition"),te=i("v-container"),Be=i("v-progress-circular"),je=i("v-overlay"),ne=i("v-skeleton-loader");return c(s)&&!ge.value?(p(),L(te,{key:0,fluid:""},{default:t(()=>[a(r,{class:"justify-center align-center mb-6"},{default:t(()=>[a(o,{cols:"auto"},{default:t(()=>[a(He)]),_:1}),a(o,null,{default:t(()=>[a(r,null,{default:t(()=>[a(o,null,{default:t(()=>[D("p",st,[e[7]||(e[7]=v("Lezioni del ")),D("b",null,V(c(le).fromIyyyyMMdd(c(s).date).format()),1)])]),_:1})]),_:1}),a(r,{class:"justify-center"},{default:t(()=>[a(o,{cols:"auto"},{default:t(()=>[D("span",ot,[e[8]||(e[8]=v(" Totale: ")),D("b",null,V(c(s).salary)+" €",1)])]),_:1})]),_:1})]),_:1})]),_:1}),a(r,null,{default:t(()=>[a(o,null,{default:t(()=>[a(f,{onClick:ve,disabled:!re.value},{default:t(()=>e[9]||(e[9]=[v("presenti")])),_:1},8,["disabled"])]),_:1}),a(o,null,{default:t(()=>[a(f,{onClick:me,disabled:!re.value},{default:t(()=>e[10]||(e[10]=[v("assenti")])),_:1},8,["disabled"])]),_:1}),a(o,null,{default:t(()=>[a(ee,{modelValue:E.value,"onUpdate:modelValue":e[2]||(e[2]=d=>E.value=d),transition:"dialog-bottom-transition","max-width":"500",persistent:""},{activator:t(({props:d})=>[a(f,Y({onClick:ke},d),{default:t(()=>e[11]||(e[11]=[v("Aggiungi studente")])),_:2},1040)]),default:t(()=>[a(h,{title:"Tutti gli studenti della scuola",loading:z.value},{default:t(()=>[a(R,null,{default:t(()=>[a(nt,{modelValue:x.value,"onUpdate:modelValue":e[0]||(e[0]=d=>x.value=d),"all-students":j.value},null,8,["modelValue","all-students"])]),_:1}),a(b,null,{default:t(()=>[a(f,{text:"Annulla",onClick:e[1]||(e[1]=d=>E.value=!1)}),a(S),a(f,{color:"primary",text:"Salva",onClick:Ce,loading:H.value},null,8,["loading"])]),_:1})]),_:1},8,["loading"])]),_:1},8,["modelValue"])]),_:1}),a(o,null,{default:t(()=>[a(Ae,{modelValue:k.value,"onUpdate:modelValue":e[3]||(e[3]=d=>k.value=d),indeterminate:m.value.length!=0&&m.value.length!=n.value.length,onClick:Ie},null,8,["modelValue","indeterminate"])]),_:1}),a(o,null,{default:t(()=>[a(_e,{name:c(le).fromIyyyyMMdd(c(s).date).format(),objName:"Lezione Giornaliera",onDelete:async()=>await Ee()},{activator:t(({props:d})=>[a(f,Y({color:"error"},d),{default:t(()=>e[12]||(e[12]=[v("elimina lezione")])),_:2},1040)]),_:1},8,["name","onDelete"])]),_:1}),a(o,null,{default:t(()=>[a($e,{modelValue:G.value,"onUpdate:modelValue":e[4]||(e[4]=d=>G.value=d),mandatory:"",shaped:""},{default:t(()=>[a(f,null,{default:t(()=>[a(fe,null,{default:t(()=>e[13]||(e[13]=[v("mdi-timeline-text-outline")])),_:1})]),_:1}),a(f,null,{default:t(()=>[a(fe,null,{default:t(()=>e[14]||(e[14]=[v("mdi-calendar-week-begin-outline")])),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),a(te,{fluid:""},{default:t(()=>[a(Ue,{"leave-absolute":""},{default:t(()=>[G.value==1?(p(),L(Oe,{key:0,date:c(le).fromIyyyyMMdd(c(s).date),modelValue:n.value,"onUpdate:modelValue":e[5]||(e[5]=d=>n.value=d),editable:"",sort:"",onEdit:M},null,8,["date","modelValue"])):(p(),L(Re,{key:1,side:"end","truncate-line":"both"},{default:t(()=>[(p(!0),ue(ie,null,ye(n.value,(d,pe)=>(p(),L(Me,{key:d.id+c(s).id,"dot-color":Se(d),size:"small"},{default:t(()=>[(p(),L(lt,{key:d.id+c(s).id,item:n.value[pe],"onUpdate:item":C=>n.value[pe]=C,select:m.value,"onUpdate:select":e[6]||(e[6]=C=>m.value=C),onPresent:C=>ve(d),onAbsent:C=>me(d),onCancel:C=>Le(d),onReset:C=>Te(d),updateLessonTime:async C=>await be(d,C),onNotes:C=>void 0,onDeleteLessonItem:async()=>await Ve(d)},null,8,["item","onUpdate:item","select","onPresent","onAbsent","onCancel","onReset","updateLessonTime","onNotes","onDeleteLessonItem"]))]),_:2},1032,["dot-color"]))),128))]),_:1}))]),_:1})]),_:1}),a(je,{"model-value":$.value,class:"align-center justify-center"},{default:t(()=>[a(Be,{color:"primary",size:"64",indeterminate:""})]),_:1},8,["model-value"])]),_:1})):(p(),L(te,{key:1,fluid:""},{default:t(()=>[a(ne,{class:"mx-auto",type:"heading"}),a(ne,{class:"mx-auto justify-center",type:"chip, chip, chip, chip, chip, chip, chip"}),(p(),ue(ie,null,ye(3,d=>a(ne,{key:d,class:"mx-auto justify-center mt-4","max-width":"75%",elevation:"3",type:"sentences, chip, chip, chip, chip"})),64))]),_:1}))}}});export{gt as default};
