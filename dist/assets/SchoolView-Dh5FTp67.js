import{_ as Ie}from"./DeleteDialog.vue_vue_type_script_setup_true_lang-D5HHt7vf.js";import{_ as tt}from"./BackButton.vue_vue_type_script_setup_true_lang-BGb1NAmh.js";import{_ as ot}from"./SchoolEditor.vue_vue_type_script_setup_true_lang-CUl1L1E7.js";import{S as nt}from"./school-repository-Cn0NCeLd.js";import{W as xe,v as at,S as Ce,a as lt,D as Re,b as We,c as we,d as st,e as Me,f as it}from"./school-service-B5Hex-sR.js";import{d as se,r as k,i as Z,n as F,p as pe,T as _e,a as ye,o as ce,b as o,e as f,c as U,w as t,f as e,m as q,u as s,q as Q,k as te,t as P,j as oe,g as H,s as Pe,v as ut,h as re,F as ue,l as A,x as dt,y as Ee,z as qe,A as rt,B as Ae,C as ct,D as mt,E as Ge,G as vt,H as pt}from"./index-C2OCLzvt.js";import{d as ne,y as E,T as le,r as ft,L as _t}from"./model-DjcFpkp9.js";import{c as Te,a as ie,b as he,d as je,u as $e,e as yt}from"./index.esm--OEcS--c.js";import{D as gt}from"./DailyLessonCalendar-Dr122K0u.js";import{L as bt}from"./lesson-group-service-DD0iNLHs.js";import{_ as St}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./schedule-x-vue-CuN1apsR.js";const ht={key:1,class:"text-grey text-caption align-self-center"},Oe=se({__name:"WeekLessonEditor",props:{school:{default:()=>({id:"1"})},edit:{type:Boolean},initialWeekLesson:{}},emits:["close","save"],setup(j,{emit:R}){const p=R,v=j,b=[];let u;const c=k([]),I=k([]),D=k([]),x=k([]),r=k(!1),a=k(!1),V=k(!1),h=Te({dayOfWeek:ie().required("Il Giorno è obbligatorio").label("Giorno"),from:he().required("La Data di Inizio delle lezioni settimanali è obbligatoria").label("Dal"),to:he().required("La Data di Fine delle lezioni settimanali è obbligatoria").label("Al"),excludeDates:je().of(he()).label("Giorni da Escludere").nullable().optional(),startingTime:ie().required("L'Orario della prima Lezione è obbligatorio").label("Orario della prima Lezione")}),{defineField:m,handleSubmit:n}=$e({validationSchema:h}),d=L=>({props:{"error-messages":L.errors}}),[i,w]=m("dayOfWeek",d),[g,T]=m("from",d),[S,B]=m("to",d),[C,O]=m("excludeDates",d),[W,ae]=m("startingTime",d);let Y=!1;const K=k([]),z=n(async L=>{ke()},L=>{Z.warn("Ci sono alcuni errori! Inserisci correttamente i dati"),console.log(L)});F(()=>v.initialWeekLesson,()=>be()),F(i,()=>fe()),F(g,()=>fe()),F(S,()=>fe()),F(x,()=>de()),F(W,()=>{ge(),Y=!1}),F(i,async()=>await J()),F(K,()=>Le(),{deep:!0});const _=pe(()=>x.value.length===D.value.length),y=pe(()=>x.value.length>0);function $(){_.value?x.value=[]:x.value=D.value.slice()}function de(){var L;for(const l of x.value)if(c.value.findIndex(N=>N.studentId===l.id)===-1){const N=c.value.reduce((ve,Se)=>Se.endTime>ve?Se.endTime:ve,((L=le.fromHHMM(W.value))==null?void 0:L.getTotalMinutes())??0),X=l.minutesLessonDuration||0,ee=N+X*60;c.value.push({lessonId:at(),studentId:l.id,startTime:N,endTime:ee})}for(const l of[...c.value])if(x.value.findIndex(N=>N.id==l.studentId)==-1){const N=c.value.indexOf(l);c.value.splice(N,1)}ge()}function ge(){var l;if(!Y&&c.value.length>0){c.value.sort((X,ee)=>X.startTime-ee.startTime);const N=(((l=le.fromHHMM(W.value))==null?void 0:l.getTotalMinutes())??0)*60-c.value[0].startTime;c.value.forEach(X=>{X.startTime+=N,X.endTime+=N})}const L=E.today();K.value=c.value.map(M=>{const N=me(M.studentId);return{id:M.lessonId,start:L.toIyyyyMMdd("-")+" "+le.fromITime(M.startTime).format(),end:L.toIyyyyMMdd("-")+" "+le.fromITime(M.endTime).format(),title:`${De(M.studentId)} - ${Ve(M.studentId)}`,data:{...M,...N}}})}function Le(){c.value=K.value.map(L=>{const l=L.start.split(" ")[1],M=L.end.split(" ")[1];return{lessonId:L.data.lessonId,startTime:le.fromHHMM(l).toITime(),endTime:le.fromHHMM(M).toITime(),studentId:L.data.studentId}})}function be(){if(v.initialWeekLesson){const L=JSON.parse(JSON.stringify(v.initialWeekLesson));i.value=ne[L.dayOfWeek],g.value=E.fromIyyyyMMdd(L.from).toDate(),S.value=E.fromIyyyyMMdd(L.to).toDate(),C.value=L.exclude.map(M=>E.fromIyyyyMMdd(M).toDate()),c.value=L.schedule;const l=c.value.map(M=>M.studentId);if(x.value=D.value.filter(M=>l.includes(M.id)),c.value.length>0){Y=!0;const M=c.value[0].startTime;W.value=le.fromITime(M).format()}}}function fe(){if(i.value===void 0||g.value===void 0||S.value===void 0)return;I.value=[];const L=ne.indexOf(i.value);let l=new Date(g.value);for(;l<=S.value;){if(l.getDay()===L){const M=new Date(l);I.value.push({name:ut(M),value:M})}l.setDate(l.getDate()+1)}}async function ke(L){var M,N,X;a.value=!0;const l={schoolId:v.school.id,dayOfWeek:ne.indexOf(i.value),from:E.fromDate(g.value).toIyyyyMMdd(),to:E.fromDate(S.value).toIyyyyMMdd(),exclude:((M=C.value)==null?void 0:M.map(ee=>E.fromDate(ee).toIyyyyMMdd()))??[],schedule:c.value.sort((ee,ve)=>ee.startTime-ve.startTime),createdAt:v.edit?(N=v.initialWeekLesson)==null?void 0:N.createdAt:_e.now(),updatedAt:_e.now()};try{v.edit&&((X=v.initialWeekLesson)==null?void 0:X.id)!=null?(await xe.instance.save(l,v.initialWeekLesson.id),Z.success("Lezione Settimanale Aggiornata")):(await xe.instance.save(l),Z.success("Lezione Settimanale Creata")),p("save",l)}catch(ee){p("save"),Z.error("Errore durante il salvataggio"),console.error("Error adding document (schools): ",ee)}finally{a.value=!1}}function me(L){return D.value.find(l=>l.id==L)}function De(L){let l;return typeof L=="string"?l=me(L):l=L,`${l==null?void 0:l.name} ${l==null?void 0:l.surname}`}function Ve(L){let l;return typeof L=="string"?l=me(L):l=L,ne[(l==null?void 0:l.lessonDay)??0]}async function J(){u==null||u.unsubscribe(),V.value=!0;const L=new Promise((l,M)=>{u=Ce.instance.observeStudentsOfSchool(v.school.id).subscribe({next:N=>{D.value=N,V.value=!1,l()},error:N=>{V.value=!1,M(N)}})});b.push(u),await L}return ye(()=>{b.forEach(L=>L.unsubscribe())}),ce(async()=>{await J(),be()}),(L,l)=>{const M=o("v-select"),N=o("v-col"),X=o("v-row"),ee=o("v-date-input"),ve=o("v-chip"),Se=o("v-time-picker"),He=o("v-dialog"),Fe=o("v-text-field"),Be=o("v-checkbox-btn"),Je=o("v-list-item"),Qe=o("v-divider"),Ye=o("v-form"),Ke=o("v-card-text"),Xe=o("v-spacer"),Ue=o("v-btn"),Ze=o("v-card-actions"),et=o("v-card");return f(),U(et,{title:"Lezione Settimanale"},{default:t(()=>[e(Ke,null,{default:t(()=>[e(Ye,{class:"ma-2"},{default:t(()=>[e(X,{class:"my-1 justify-center"},{default:t(()=>[e(N,{class:"px-2"},{default:t(()=>[e(M,q({modelValue:s(i),"onUpdate:modelValue":l[0]||(l[0]=G=>Q(i)?i.value=G:null)},s(w),{items:s(ne),label:"Giorno",required:""}),null,16,["modelValue","items"])]),_:1})]),_:1}),e(X,{class:"my-1 justify-center"},{default:t(()=>[e(N,{class:"px-2",cols:"12",md:"4"},{default:t(()=>[e(ee,q({max:s(S),modelValue:s(g),"onUpdate:modelValue":l[1]||(l[1]=G=>Q(g)?g.value=G:null)},s(T),{label:"Dal",inputmode:"none"}),null,16,["max","modelValue"])]),_:1}),e(N,{class:"px-2",cols:"12",md:"4"},{default:t(()=>[e(ee,q({min:s(g),modelValue:s(S),"onUpdate:modelValue":l[2]||(l[2]=G=>Q(S)?S.value=G:null)},s(B),{label:"Al",inputmode:"none"}),null,16,["min","modelValue"])]),_:1}),e(N,{class:"px-2",cols:"12",md:"4"},{default:t(()=>[e(M,q({modelValue:s(C),"onUpdate:modelValue":l[3]||(l[3]=G=>Q(C)?C.value=G:null)},s(O),{items:I.value,label:"Giorni da Escludere",multiple:"","item-title":"name","item-value":"value","no-data-text":"Nessuna Data Disponibile",clearable:""}),{selection:t(({item:G,index:ze})=>[ze<2?(f(),U(ve,{key:0},{default:t(()=>[te("span",null,P(G.title),1)]),_:2},1024)):oe("",!0),ze===2?(f(),H("span",ht," (+"+P(s(C).length-2)+" others) ",1)):oe("",!0)]),_:1},16,["modelValue","items"])]),_:1})]),_:1}),e(X,{class:"my-1 justify-center"},{default:t(()=>[e(N,{class:"px-2",cols:"12",md:"6"},{default:t(()=>[e(Fe,q({modelValue:s(W),"onUpdate:modelValue":l[6]||(l[6]=G=>Q(W)?W.value=G:null)},s(ae),{active:r.value,focused:r.value,inputmode:"none",label:"Orario della prima Lezione","prepend-icon":"mdi-clock-time-four-outline",readonly:""}),{default:t(()=>[e(He,{modelValue:r.value,"onUpdate:modelValue":l[5]||(l[5]=G=>r.value=G),activator:"parent",width:"auto"},{default:t(()=>[r.value?(f(),U(Se,{key:0,modelValue:s(W),"onUpdate:modelValue":l[4]||(l[4]=G=>Q(W)?W.value=G:null),format:"24hr"},null,8,["modelValue"])):oe("",!0)]),_:1},8,["modelValue"])]),_:1},16,["modelValue","active","focused"])]),_:1}),e(N,{class:"px-2",cols:"12",md:"6"},{default:t(()=>[e(M,{modelValue:x.value,"onUpdate:modelValue":l[7]||(l[7]=G=>x.value=G),items:D.value,label:"Studenti","item-title":"name","item-value":"id","return-object":!0,multiple:"","no-data-text":"Nessuno studente disponibile per questa scuola"},Pe({_:2},[D.value.length>1?{name:"prepend-item",fn:t(()=>[e(Je,{title:"Seleziona tutti",onClick:$},{prepend:t(()=>[e(Be,{color:y.value?"indigo-darken-4":void 0,indeterminate:y.value&&!_.value,"model-value":_.value},null,8,["color","indeterminate","model-value"])]),_:1}),e(Qe,{class:"mt-2"})]),key:"0"}:void 0]),1032,["modelValue","items"])]),_:1})]),_:1})]),_:1}),e(gt,{modelValue:K.value,"onUpdate:modelValue":l[8]||(l[8]=G=>K.value=G),editable:""},null,8,["modelValue"])]),_:1}),e(Ze,null,{default:t(()=>[e(Xe),e(Ue,{text:"Chiudi",onClick:l[9]||(l[9]=G=>p("close"))}),e(Ue,{text:"Salva",color:"primary",onClick:s(z),loading:a.value},null,8,["onClick","loading"])]),_:1})]),_:1})}}}),Lt={key:1},kt=se({__name:"CalendarLessonEditor",props:{school:{}},emits:["close"],setup(j,{emit:R}){const p=j,v=R,b=[],u=k([]),c=k(!1),I=k(!1),D=k([]),x=k(!1);async function r(m){if(!m)return!1;try{return await xe.instance.delete(m.id),!0}catch{return!1}}async function a(){c.value=!0;const m=lt.instance.observeWeekLessonOfSchool(p.school.id).subscribe({next:n=>{u.value=n,c.value=!1},error:n=>c.value=!1});b.push(m)}async function V(){I.value=!0;const m=Ce.instance.observeStudentsOfSchool(p.school.id).subscribe({next:n=>{D.value=n,I.value=!1},error:n=>I.value=!1});b.push(m)}function h(m){const n=D.value.find(d=>d.id==m);return`${n==null?void 0:n.name} ${n==null?void 0:n.surname}`}return ce(async()=>{await V(),await a()}),ye(()=>{b.forEach(m=>m.unsubscribe())}),(m,n)=>{const d=o("v-btn"),i=o("v-dialog"),w=o("v-col"),g=o("v-row"),T=o("v-expansion-panel-title"),S=o("v-list-item"),B=o("v-list"),C=o("v-expansion-panel-text"),O=o("v-expansion-panel"),W=o("v-expansion-panels"),ae=o("v-card-text"),Y=o("v-spacer"),K=o("v-card-actions"),z=o("v-card");return f(),U(z,{title:"Calendario",loading:c.value||I.value},{append:t(()=>[e(i,{modelValue:x.value,"onUpdate:modelValue":n[2]||(n[2]=_=>x.value=_),transition:"dialog-bottom-transition",fullscreen:""},{activator:t(({props:_})=>[e(d,q({icon:"mdi-plus"},_,{variant:"text"}),null,16)]),default:t(()=>[e(Oe,{school:m.school,onClose:n[0]||(n[0]=_=>x.value=!1),onSave:n[1]||(n[1]=_=>_?x.value=!1:null)},null,8,["school"])]),_:1},8,["modelValue"])]),default:t(()=>[e(ae,null,{default:t(()=>[e(W,null,{default:t(()=>[(f(!0),H(ue,null,re(u.value,_=>(f(),U(O,{key:_.id},{default:t(()=>[e(T,null,{default:t(()=>[e(g,{"no-gutters":""},{default:t(()=>[e(w,{class:"d-flex justify-start",cols:"5"},{default:t(()=>[te("span",null,[n[5]||(n[5]=A("Tutti i ")),te("b",null,P(s(ne)[_.dayOfWeek]),1)])]),_:2},1024),e(w,{class:"text-grey",cols:"5"},{default:t(()=>[A(" Dal "+P(s(E).fromIyyyyMMdd(_.from).format())+" al "+P(s(E).fromIyyyyMMdd(_.to).format()),1)]),_:2},1024),e(w,{cols:"1"},{default:t(()=>[e(i,{transition:"dialog-bottom-transition",fullscreen:""},{activator:t(({props:y})=>[e(d,q({icon:"mdi-pencil",variant:"text",onClick:n[3]||(n[3]=dt($=>console.log("edit"),["stop"])),ref_for:!0},y),null,16)]),default:t(({isActive:y})=>[e(Oe,{school:m.school,initialWeekLesson:_,edit:"",onClose:$=>y.value=!1,onSave:$=>$?y.value=!1:null},null,8,["school","initialWeekLesson","onClose","onSave"])]),_:2},1024)]),_:2},1024),e(w,{cols:"1"},{default:t(()=>[e(Ie,{name:"Tutti i "+s(ne)[_.dayOfWeek],objName:"Lezione Programmata",onDelete:async()=>await r(_)},{activator:t(({props:y})=>[e(d,q({icon:"mdi-delete",variant:"text",ref_for:!0},y),null,16)]),_:2},1032,["name","onDelete"])]),_:2},1024)]),_:2},1024)]),_:2},1024),e(C,null,{default:t(()=>[_.schedule.length>0?(f(),U(B,{key:0},{default:t(()=>[(f(!0),H(ue,null,re(_.schedule,y=>(f(),U(S,{key:y.studentId,value:y,color:"primary"},{prepend:t(()=>[te("p",null,[te("b",null,P(s(le).fromITime(y.startTime).format())+" - "+P(s(le).fromITime(y.endTime).format()),1),n[6]||(n[6]=te("span",null," - ",-1)),te("i",null,P(h(y.studentId)),1)])]),_:2},1032,["value"]))),128))]),_:2},1024)):(f(),H("span",Lt,"Nessuna lezione programmata"))]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),e(K,null,{default:t(()=>[e(Y),e(d,{text:"Chiudi",onClick:n[4]||(n[4]=_=>v("close"))})]),_:1})]),_:1},8,["loading"])}}}),Dt=se({__name:"LessonView",props:{school:{}},setup(j){const R=Ee(),p=qe(),v=j,b=[],u=k([]),c=k(),I=k(!1),D=k(!1),x=k(!1),r={dailyLessons:[],weeklyLessons:[],schoolId:v.school.id},a=pe(()=>v.school==null||I.value||D.value||x.value);F(v.school,()=>m());function V(n){return n.next?"primary":n.pending?"warning":n.recovery?"info":"grey-lighten-1"}async function h(n){const d=await Re.instance.getOrCreateDailyLessonId(r,n);R.push(`/lesson/${d}`)}async function m(){x.value=!0;const n=new Date(new Date().toDateString()),d=p.addMonths(n,-12),i=await We.instance.getSchoolLessons(v.school.id,d);u.value=await bt.instance.getGroupedLessons(i),x.value=!1}return ce(async()=>{await m()}),ye(()=>{b.forEach(n=>n==null?void 0:n())}),(n,d)=>{const i=o("v-btn"),w=o("v-date-picker"),g=o("v-col"),T=o("v-row"),S=o("v-card-text"),B=o("v-spacer"),C=o("v-card-actions"),O=o("v-card"),W=o("v-dialog"),ae=o("v-list-subheader"),Y=o("v-icon"),K=o("v-avatar"),z=o("v-list-item"),_=o("v-list");return f(),U(O,{title:"Lezioni",elevation:"3",loading:a.value},{append:t(()=>[e(W,{transition:"dialog-bottom-transition",class:"justify-center"},{activator:t(({props:y})=>[e(i,q({icon:"mdi-calendar",variant:"text",disabled:!n.school},y),null,16,["disabled"])]),default:t(({isActive:y})=>[e(O,{maxWidth:"400px"},{default:t(()=>[e(S,null,{default:t(()=>[e(T,{class:"justify-center"},{default:t(()=>[e(g,{cols:"auto"},{default:t(()=>[e(w,{modelValue:c.value,"onUpdate:modelValue":d[0]||(d[0]=$=>c.value=$)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),e(C,null,{default:t(()=>[e(B),e(i,{text:"Chiudi",onClick:$=>y.value=!1},null,8,["onClick"]),e(i,{text:"Ok",color:"primary",onClick:d[1]||(d[1]=$=>h(c.value)),disabled:!c.value},null,8,["disabled"])]),_:2},1024)]),_:2},1024)]),_:1}),e(i,{icon:"mdi-refresh",variant:"text",disabled:!n.school||x.value,onClick:m},null,8,["disabled"]),e(W,{transition:"dialog-bottom-transition",fullscreen:""},{activator:t(({props:y})=>[e(i,q({icon:"mdi-pencil",variant:"text"},y,{disabled:!n.school}),null,16,["disabled"])]),default:t(({isActive:y})=>[e(kt,{school:n.school,onClose:$=>{y.value=!1,m()}},null,8,["school","onClose"])]),_:1}),e(i,{icon:"mdi-eye-arrow-right",variant:"text",to:"/lessons/"+n.school.id},null,8,["to"])]),default:t(()=>[e(_,{lines:"two"},{default:t(()=>[(f(!0),H(ue,null,re(u.value,y=>(f(),H(ue,{key:y.month},[e(ae,{inset:""},{default:t(()=>[A(P(y.month),1)]),_:2},1024),(f(!0),H(ue,null,re(y.lessons,$=>(f(),U(z,{key:$.date.toString(),title:$.date.format(),onClick:de=>h($),baseColor:$.next?"primary":""},Pe({prepend:t(()=>[e(K,{color:V($)},{default:t(()=>[e(Y,{color:"white"},{default:t(()=>d[2]||(d[2]=[A("mdi-calendar")])),_:1})]),_:2},1032,["color"])]),_:2},[$.pending||$.recovery?{name:"append",fn:t(()=>[$.pending?(f(),U(Y,{key:0,color:"warning"},{default:t(()=>d[3]||(d[3]=[A("mdi-alert")])),_:1})):oe("",!0),$.recovery?(f(),U(Y,{key:1,color:"info"},{default:t(()=>d[4]||(d[4]=[A("mdi-alpha-r-circle")])),_:1})):oe("",!0)]),key:"0"}:void 0]),1032,["title","onClick","baseColor"]))),128))],64))),128))]),_:1})]),_:1},8,["loading"])}}}),Vt=St(Dt,[["__scopeId","data-v-c41e1ade"]]),xt=se({__name:"ScheduleRecoveryLessonButton",props:rt({school:{}},{modelValue:{required:!0},modelModifiers:{}}),emits:["update:modelValue"],setup(j){const R=j,p=Ae(j,"modelValue"),v=k(!1),b=k(!1),u=k(!1),c=Te({date:he().required("La Data della Lezione di Recupero è obbligatoria").label("Data della Lezione di Recupero"),time:ie().required("L'Orario della Lezione di Recupero è obbligatorio").label("Orario della Lezione di Recupero")}),{defineField:I,handleSubmit:D,resetForm:x}=$e({validationSchema:c}),r=w=>({props:{"error-messages":w.errors}}),[a,V]=I("date",r),[h,m]=I("time",r),n=D(async w=>{i()},w=>{Z.warn("Ci sono alcuni errori! Inserisci correttamente i dati"),console.log(w)});function d(){b.value=!1,a.value=void 0,h.value=void 0,x()}async function i(){if(!(!a.value||!h.value||!p.value))try{u.value=!0;const w=le.fromHHMM(h.value),g={studentId:p.value.studentId,schoolId:R.school.id,originalDailyLessonId:p.value.originalDailyLesson.id,originalLessonId:p.value.lessonId,date:a.value,startTime:w.toITime(),endTime:w.add({minutes:p.value.minutesLessonDuration}).toITime()};await we.instance.scheduleRecovery(p.value,g),b.value=!1}catch{Z.error("Impossibile schedulare la lezione di recupero")}finally{u.value=!1}}return(w,g)=>{const T=o("v-btn"),S=o("v-date-input"),B=o("v-col"),C=o("v-time-picker"),O=o("v-dialog"),W=o("v-text-field"),ae=o("v-row"),Y=o("v-card-text"),K=o("v-spacer"),z=o("v-card-actions"),_=o("v-card");return f(),U(O,{modelValue:b.value,"onUpdate:modelValue":g[5]||(g[5]=y=>b.value=y),width:"auto",scrollable:"",persistent:""},{activator:t(({props:y})=>[e(T,ct(mt(y)),{default:t(()=>g[6]||(g[6]=[A("programma")])),_:2},1040)]),default:t(()=>[e(_,{title:"Programma Lezione di Recupero",subtitle:p.value.name+" "+p.value.surname+" - "+s(E).fromIyyyyMMdd(p.value.originalDailyLesson.date).format(),loading:u.value},{default:t(()=>[e(Y,{class:"pa-6"},{default:t(()=>[e(ae,null,{default:t(()=>[e(B,{cols:"12",md:"12"},{default:t(()=>[e(S,q({modelValue:s(a),"onUpdate:modelValue":g[0]||(g[0]=y=>Q(a)?a.value=y:null)},s(V),{label:"Data della Lezione di Recupero",inputmode:"none"}),null,16,["modelValue"])]),_:1}),e(B,{cols:"12",lg:"12"},{default:t(()=>[e(W,q({modelValue:s(h),"onUpdate:modelValue":g[3]||(g[3]=y=>Q(h)?h.value=y:null)},s(m),{active:v.value,focused:v.value,inputmode:"none",label:"Orario della prima Lezione","prepend-icon":"mdi-clock-time-four-outline",readonly:""}),{default:t(()=>[e(O,{modelValue:v.value,"onUpdate:modelValue":g[2]||(g[2]=y=>v.value=y),activator:"parent",width:"auto"},{default:t(()=>[v.value?(f(),U(C,{key:0,modelValue:s(h),"onUpdate:modelValue":g[1]||(g[1]=y=>Q(h)?h.value=y:null),format:"24hr"},null,8,["modelValue"])):oe("",!0)]),_:1},8,["modelValue"])]),_:1},16,["modelValue","active","focused"])]),_:1})]),_:1})]),_:1}),e(z,null,{default:t(()=>[e(K),e(T,{text:"Annulla",onClick:d}),e(T,{color:"primary",text:"Salva",onClick:g[4]||(g[4]=y=>s(n)(y))})]),_:1})]),_:1},8,["subtitle","loading"])]),_:1},8,["modelValue"])}}}),wt={key:0},Mt={key:1},It={key:2},Ct={key:0},Tt={key:1},$t={key:0},Ut={key:2},zt={key:0},Ot=se({__name:"RecoveryLessonView",props:{school:{}},setup(j){const R=j,p=pe(()=>R.school.id),v=st.instance.observe(p),b=Ge(v),u=k(),c=k(!1),I=k(!1);F(b,async()=>x());async function D(r){try{I.value=!0,await we.instance.cancelRecovery(r)}catch{Z.warn("Impossibile annullare la lezione di recupero")}finally{I.value=!1}}async function x(){if(b.value)try{c.value=!0,u.value=await we.instance.computeDailyLessons(b.value),console.log(u)}catch{Z.warning("Impossibile caricare le Lezioni di Recupero")}finally{c.value=!1}}return(r,a)=>{const V=o("v-list-subheader"),h=o("v-list-item"),m=o("v-btn"),n=o("v-icon"),d=o("v-divider"),i=o("v-list"),w=o("v-card-text"),g=o("v-card");return f(),U(g,{title:"Recuperi",elevation:"3",loading:c.value},{default:t(()=>[e(i,{lines:"three"},{default:t(()=>{var T;return[(f(!0),H(ue,null,re((T=u.value)==null?void 0:T.recoveryMap,(S,B)=>(f(),H(ue,{key:S.type},[e(V,{inset:""},{default:t(()=>[te("b",null,P(s(ft)[S.type]),1)]),_:2},1024),S.recoveries.length==0?(f(),U(h,{key:0},{default:t(()=>[S.type=="unset"?(f(),H("div",wt," Nessuna lezione da recuperare ")):S.type=="pending"?(f(),H("div",Mt," Nessuna lezione di recupero programmata ")):(f(),H("div",It," Nessuna lezione di recupero effettuata "))]),_:2},1024)):oe("",!0),(f(!0),H(ue,null,re(S.recoveries,(C,O)=>(f(),U(h,{key:`${C.lessonId}_${C.originalDailyLesson.id}`},{title:t(()=>[A(P(C.name)+" "+P(C.surname),1)]),subtitle:t(()=>[S.type=="unset"?(f(),H("div",Ct," Da recuperare la lezione del "+P(s(E).fromIyyyyMMdd(C.originalDailyLesson.date).format()),1)):S.type=="pending"?(f(),H("div",Tt,[A(" Recupero della lezione del "+P(s(E).fromIyyyyMMdd(C.originalDailyLesson.date).format())+" programmato ",1),C.recoveryDailyLesson?(f(),H("span",$t," per il "+P(s(E).fromIyyyyMMdd(C.recoveryDailyLesson.date).format()),1)):oe("",!0)])):(f(),H("div",Ut,[A(" Recupero della lezione del "+P(s(E).fromIyyyyMMdd(C.originalDailyLesson.date).format())+" effettuato ",1),C.recoveryDailyLesson?(f(),H("span",zt," il "+P(s(E).fromIyyyyMMdd(C.recoveryDailyLesson.date).format()),1)):oe("",!0)]))]),append:t(()=>[S.type=="unset"?(f(),U(xt,{key:0,modelValue:S.recoveries[O],"onUpdate:modelValue":W=>S.recoveries[O]=W,school:r.school},null,8,["modelValue","onUpdate:modelValue","school"])):S.type=="pending"?(f(),U(m,{key:1,onClick:W=>D(C),loading:I.value,disabled:I.value},{default:t(()=>a[0]||(a[0]=[A("annulla")])),_:2},1032,["onClick","loading","disabled"])):C.recoveryStatus==s(_t).CANCELLED?(f(),U(n,{key:2,color:"warning"},{default:t(()=>a[1]||(a[1]=[A(" mdi-cancel ")])),_:1})):(f(),U(n,{key:3,color:"success"},{default:t(()=>a[2]||(a[2]=[A(" mdi-check-all ")])),_:1}))]),_:2},1024))),128)),B!=2?(f(),U(d,{key:1})):oe("",!0)],64))),128))]}),_:1}),u.value?oe("",!0):(f(),U(w,{key:0},{default:t(()=>a[3]||(a[3]=[A(" Nessun recupero in programma ")])),_:1}))]),_:1},8,["loading"])}}}),Ne=se({__name:"StudentEditor",props:{school:{},initialStudent:{},edit:{type:Boolean}},emits:["close","save"],setup(j,{emit:R}){const p=j,v=R,b=k(),u=k([]),c=k(!1);F(()=>p.initialStudent,()=>ae()),F(()=>p.school,()=>Y());const I=Te({name:ie().required("Il Nome è obbligatorio").min(1).label("Nome"),surname:ie().required("Il Cognome è obbligatorio").min(1).label("Cognome"),contact:ie().label("Contatto").nullable().optional(),lessonDay:ie().label("Giono di Lezione").nullable().optional(),level:ie().required("Il Livello è obbligatorio").label("Livello"),minutesLessonDuration:yt().required("La Durata della Lezione è obbligatoria").min(1).label("Durata della Lezione"),notes:je().of(ie()).label("Note")}),{defineField:D,handleSubmit:x}=$e({validationSchema:I}),r=z=>({props:{"error-messages":z.errors}}),[a,V]=D("name",r),[h,m]=D("surname",r),[n,d]=D("contact",r),[i,w]=D("lessonDay",r),[g,T]=D("level",r),[S,B]=D("minutesLessonDuration",r),[C,O]=D("notes",r),W=x(async z=>{K(z)},z=>{Z.warn("Ci sono alcuni errori! Inserisci correttamente i dati"),console.log(z)});function ae(){if(p.initialStudent){const z=JSON.parse(JSON.stringify(p.initialStudent));a.value=z.name,h.value=z.surname??"",n.value=z.contact??"",i.value=ne[z.lessonDay],g.value=z.level,C.value=z.notes??[],S.value=z.minutesLessonDuration}}function Y(){b.value=p.school,u.value=b.value.levelRanges.flatMap(z=>z.levels)}async function K(z){var y,$;c.value=!0;const _={...z};_.schoolId=b.value.id,_.createdAt=p.edit?(y=p.initialStudent)==null?void 0:y.createdAt:_e.now(),_.updatedAt=_e.now(),i.value&&(_.lessonDay=ne.indexOf(i.value));try{p.edit&&(($=p.initialStudent)==null?void 0:$.id)!=null?(await Me.instance.save(_,p.initialStudent.id),Z.success("Studente Aggiornato")):(await Me.instance.save(_),Z.success("Studente Creato")),v("save",_)}catch(de){v("save"),Z.error("Errore durante il salvataggio"),console.error("Error adding document (schools): ",de)}finally{c.value=!1}}return ce(()=>{ae(),Y()}),(z,_)=>{const y=o("v-text-field"),$=o("v-col"),de=o("v-select"),ge=o("v-number-input"),Le=o("v-row"),be=o("v-card-text"),fe=o("v-divider"),ke=o("v-spacer"),me=o("v-btn"),De=o("v-card-actions"),Ve=o("v-card");return f(),U(Ve,{"prepend-icon":"mdi-school",title:`Studente (${z.school.name})`},{default:t(()=>[e(be,null,{default:t(()=>[e(Le,{dense:""},{default:t(()=>[e($,{cols:"12",md:"6"},{default:t(()=>[e(y,q({modelValue:s(a),"onUpdate:modelValue":_[0]||(_[0]=J=>Q(a)?a.value=J:null)},s(V),{label:"Nome"}),null,16,["modelValue"])]),_:1}),e($,{cols:"12",md:"6"},{default:t(()=>[e(y,q({modelValue:s(h),"onUpdate:modelValue":_[1]||(_[1]=J=>Q(h)?h.value=J:null)},s(m),{label:"Cognome"}),null,16,["modelValue"])]),_:1}),e($,{cols:"12",md:"6"},{default:t(()=>[e(y,q({modelValue:s(n),"onUpdate:modelValue":_[2]||(_[2]=J=>Q(n)?n.value=J:null)},s(d),{label:"Contatto"}),null,16,["modelValue"])]),_:1}),e($,{cols:"12",md:"6"},{default:t(()=>[e(de,q({modelValue:s(g),"onUpdate:modelValue":_[3]||(_[3]=J=>Q(g)?g.value=J:null)},s(T),{items:u.value,label:"Livello"}),null,16,["modelValue","items"])]),_:1}),e($,{cols:"12",md:"6"},{default:t(()=>[e(de,q({modelValue:s(i),"onUpdate:modelValue":_[4]||(_[4]=J=>Q(i)?i.value=J:null)},s(w),{items:s(ne),label:"Giorno della Lezione"}),null,16,["modelValue","items"])]),_:1}),e($,{cols:"12",md:"6"},{default:t(()=>[e(ge,q({modelValue:s(S),"onUpdate:modelValue":_[5]||(_[5]=J=>Q(S)?S.value=J:null)},s(B),{reverse:!1,controlVariant:"default",label:"Durata della Lezione",suffix:"min",hideInput:!1,inset:!1,min:1}),null,16,["modelValue"])]),_:1})]),_:1})]),_:1}),e(fe),e(De,null,{default:t(()=>[e(ke),e(me,{text:"Chiudi",variant:"plain",onClick:_[6]||(_[6]=J=>v("close"))}),e(me,{color:"primary",loading:c.value,disabled:c.value,text:z.edit?"Salva Modifiche":"Crea",variant:"tonal",onClick:s(W)},null,8,["loading","disabled","text","onClick"])]),_:1})]),_:1},8,["title"])}}}),Nt=se({__name:"StudentView",props:{school:{}},setup(j){const R=j,p=[],v=k([]),b=k(!1),u=k(!1),c=[{title:"Nome",align:"start",sortable:!0,key:"name"},{title:"Cognome",key:"surname"},{title:"Contatto",key:"contact"},{title:"Giorno della Lezione",key:"lessonDay"},{title:"Operazioni",key:"actions",sortable:!1}];function I(r){r&&(u.value=!1)}async function D(r){if(!r)return!1;try{return await Me.instance.delete(r.id),!0}catch{return!1}}async function x(){b.value=!0;const r=Ce.instance.observeStudentsOfSchool(R.school.id).subscribe({next:a=>{v.value=a,b.value=!1},error:a=>b.value=!1});p.push(r)}return ce(async()=>{await x()}),ye(()=>{p.forEach(r=>r.unsubscribe())}),(r,a)=>{const V=o("v-text-field"),h=o("v-btn"),m=o("v-dialog"),n=o("v-row"),d=o("v-icon"),i=o("v-data-table"),w=o("v-card-text"),g=o("v-card");return f(),U(g,{title:"Studenti",elevation:"3",loading:b.value},{default:t(()=>[e(w,null,{default:t(()=>[e(n,{class:"mr-4 mb-1 align-center"},{default:t(()=>[e(V,{class:"ma-2","prepend-inner-icon":"mdi-magnify",density:"comfortable",placeholder:"Ricerca...",theme:"light",variant:"solo","hide-details":""}),e(m,{modelValue:u.value,"onUpdate:modelValue":a[2]||(a[2]=T=>u.value=T),fullscreen:""},{activator:t(({props:T})=>[e(h,q({"prepend-icon":"mdi-plus",color:"success"},T),{default:t(()=>a[3]||(a[3]=[A("nuovo studente")])),_:2},1040)]),default:t(()=>[e(Ne,{school:r.school,onClose:a[0]||(a[0]=T=>u.value=!1),onSave:a[1]||(a[1]=T=>I(T))},null,8,["school"])]),_:1},8,["modelValue"])]),_:1}),e(i,{headers:c,items:v.value,"item-value":"id"},{"item.lessonDay":t(({item:T})=>[A(P(s(ne)[T.lessonDay]),1)]),"item.actions":t(({item:T})=>[e(m,{fullscreen:""},{activator:t(({props:S})=>[e(d,q({class:"me-2",size:"small"},S),{default:t(()=>a[4]||(a[4]=[A(" mdi-pencil ")])),_:2},1040)]),default:t(({isActive:S})=>[e(Ne,{edit:"",school:r.school,initialStudent:T,onClose:B=>S.value=!1,onSave:B=>S.value=!1},null,8,["school","initialStudent","onClose","onSave"])]),_:2},1024),e(Ie,{name:T.name+" "+T.surname,objName:"Studente",onDelete:async()=>await D(T)},{activator:t(({props:S})=>[e(d,q({size:"small"},S),{default:t(()=>a[5]||(a[5]=[A(" mdi-delete ")])),_:2},1040)]),_:2},1032,["name","onDelete"])]),_:1},8,["items"])]),_:1})]),_:1},8,["loading"])}}}),Rt=se({__name:"DateSelect",props:{modelValue:{default:{from:void 0,to:void 0}},modelModifiers:{}},emits:["update:modelValue"],setup(j){const R=qe(),p=["Assoluto","Relativo"],v=["Ultima settimana","Ultimo mese","Ultimi 3 mesi","Ultimi 6 mesi","Ultimo anno"],b=k(p[1]),u=k(v[0]),c=k();let I=!1;const D=Ae(j,"modelValue");F(b,x),F(u,x),F(c,x),F(D,r,{immediate:!0});function x(){var a,V,h;if(I=!0,b.value==p[1]){let m;u.value==v[1]?m=R.addMonths(new Date,-1):u.value==v[2]?m=R.addMonths(new Date,-3):u.value==v[3]?m=R.addMonths(new Date,-6):u.value==v[4]?m=R.addMonths(new Date,-12):m=R.addDays(new Date,-7),D.value={from:E.fromDate(m).toIyyyyMMdd()}}else if(b.value==p[0]){const m=(a=c.value)==null?void 0:a[0],n=((V=c.value)==null?void 0:V[c.value.length-1])??((h=c.value)==null?void 0:h[0]);m&&n&&(D.value={from:E.fromDate(m).toIyyyyMMdd(),to:E.fromDate(n).toIyyyyMMdd()})}}function r(){var h,m;if(I){I=!1;return}const a=(h=D.value)==null?void 0:h.from,V=(m=D.value)==null?void 0:m.to;if(a&&!V){b.value=p[1];const n=new Date,d=new Date(n.getTime()-E.fromIyyyyMMdd(a).toDate().getTime()),i=d.getUTCFullYear()-1970,w=d.getUTCMonth(),g=d.getUTCDate()-1;g==7&&w==0&&i==0?u.value=v[0]:(g==30||w==1)&&i==0?u.value=v[1]:(g==90||w==3)&&i==0?u.value=v[2]:(g==180||w==6)&&i==0?u.value=v[3]:g==365||w==12||i==1?u.value=v[4]:(console.warn("Selected period not recognized, falling to last week"),u.value=v[0])}else if(a&&V){b.value=p[0],c.value=[];const n=E.fromIyyyyMMdd(a).toDate(),d=E.fromIyyyyMMdd(V).toDate();for(const i=n;i<=d;i.setDate(i.getDate()+1))c.value.push(new Date(i))}}return(a,V)=>{const h=o("v-select"),m=o("v-col"),n=o("v-date-input"),d=o("v-row");return f(),U(d,{class:"px-2 mb-2"},{default:t(()=>[e(m,{cols:"12",md:"6"},{default:t(()=>[e(h,{variant:"outlined",density:"compact",modelValue:b.value,"onUpdate:modelValue":V[0]||(V[0]=i=>b.value=i),items:p,"hide-details":""},null,8,["modelValue"])]),_:1}),b.value==p[0]?(f(),U(m,{key:0,cols:"12",md:"6"},{default:t(()=>[e(n,{variant:"outlined",density:"compact",modelValue:c.value,"onUpdate:modelValue":V[1]||(V[1]=i=>c.value=i),multiple:"range",inputmode:"none","hide-details":""},null,8,["modelValue"])]),_:1})):(f(),U(m,{key:1,cols:"12",md:"6"},{default:t(()=>[e(h,{variant:"outlined",density:"compact",modelValue:u.value,"onUpdate:modelValue":V[2]||(V[2]=i=>u.value=i),items:v,"hide-details":""},null,8,["modelValue"])]),_:1}))]),_:1})}}}),Wt={class:"d-flex justify-center"},Pt={colspan:"6",class:"text-center font-weight-bold"},Et=se({__name:"SalaryView",props:{school:{}},setup(j){const R=j,p=k([]),v=k(!1),b=k({}),u=k({}),c=[{title:"Data",align:"start",sortable:!0,key:"date"},{title:"Presenti",key:"presents"},{title:"Assenti",key:"absents"},{title:"Stipendio giornaliero",key:"salary"},{title:"Aggiornato il",key:"lastUpdate"},{title:"Operazioni",key:"actions",sortable:!1}],I=pe(()=>p.value.reduce((r,a)=>r+a.salary,0));F(u,D);async function D(){if(!u.value||!u.value.from)return;const r=u.value.to??E.today().toIyyyyMMdd();v.value=!0,p.value=await it.instance.computeSalary(R.school,u.value.from,r),v.value=!1}async function x(r,a){b.value[r.dailyLessonId]=!0;const V=await Re.instance.computeSalaryOfDailyLesson(R.school,r.dailyLessonId);V?(p.value[a].salary=V.salary,p.value[a].lastUpdate=V.lastSalaryUpdate):Z.info(`Lo stipendio della lezione del ${E.fromIyyyyMMdd(r.date).format()} è già aggiornato!`),b.value[r.dailyLessonId]=!1}return ce(async()=>{await D()}),(r,a)=>{const V=o("v-btn"),h=o("v-data-table"),m=o("v-card-text"),n=o("v-card");return f(),U(n,{title:"Stipendio",elevation:"3",loading:v.value},{default:t(()=>[e(m,null,{default:t(()=>[e(Rt,{modelValue:u.value,"onUpdate:modelValue":a[0]||(a[0]=d=>u.value=d)},null,8,["modelValue"]),e(h,{headers:c,items:p.value,"item-value":"id"},{"item.date":t(({item:d})=>[A(P(s(E).fromIyyyyMMdd(d.date).format()),1)]),"item.lastUpdate":t(({item:d})=>[A(P(d.lastUpdate?s(vt)(new(s(_e))(d.lastUpdate.seconds,d.lastUpdate.nanoseconds).toDate()):""),1)]),"item.actions":t(({item:d,index:i})=>[te("div",Wt,[e(V,{icon:"mdi-refresh",variant:"text",onClick:w=>x(d,i),loading:b.value[d.dailyLessonId]},null,8,["onClick","loading"])])]),"body.append":t(()=>[te("tr",null,[te("td",Pt,"Totale "+P(I.value)+" €",1)])]),_:1},8,["items"])]),_:1})]),_:1},8,["loading"])}}}),Zt=se({__name:"SchoolView",setup(j){const R=pt(),p=Ee(),v=pe(()=>R.params.id),b=nt.instance.observe(v),u=Ge(b),c=[],I=k([]);async function D(){if(!u.value)return!1;try{return We.instance.delete(b.value),p.push("/"),!0}catch{return!1}}async function x(){const r=[{id:0,title:"Questa è una nota molto carina e paffutella",description:"",student:"Matteo Rossi"},{id:1,title:"Questa è una nota con descrizione",description:"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Ut viverra tincidunt risus sit amet interdum. Nam sed leo id ipsum efficitur congue nec ut est. Nullam in metus leo. In commodo, leo eu vulputate euismod, urna lacus efficitur nibh, ut maximus felis metus eu odio. Duis cursus commodo auctor. Suspendisse condimentum lorem dui, id tristique lectus commodo nec.",student:"Luca Verdi"}];I.value=r}return ce(async()=>{await x()}),ye(()=>{c.forEach(r=>r())}),(r,a)=>{const V=o("v-btn"),h=o("v-list-item"),m=o("v-dialog"),n=o("v-list"),d=o("v-menu"),i=o("v-col"),w=o("v-row"),g=o("v-expansion-panel-title"),T=o("v-expansion-panel-text"),S=o("v-expansion-panel"),B=o("v-expansion-panels"),C=o("v-card");return s(u)?(f(),U(C,{key:0,class:"pa-3",title:s(u).name,elevation:"0"},{prepend:t(()=>[e(tt)]),append:t(()=>[e(d,{transition:"slide-y-transition"},{activator:t(({props:O})=>[e(V,q({icon:"mdi-dots-vertical",variant:"text"},O),null,16)]),default:t(()=>[e(n,null,{default:t(()=>[e(m,{fullscreen:""},{activator:t(({props:O})=>[e(h,q({title:"Modifica"},O),null,16)]),default:t(({isActive:O})=>[e(ot,{edit:"",initialSchool:s(u),onClose:W=>O.value=!1,onSave:W=>O.value=!1},null,8,["initialSchool","onClose","onSave"])]),_:1}),e(Ie,{name:s(u).name,objName:"Scuola",onDelete:D},{activator:t(({props:O})=>[e(h,q({title:"Elimina"},O),null,16)]),_:1},8,["name"])]),_:1})]),_:1})]),default:t(()=>[e(w,{class:"mt-5"},{default:t(()=>[e(i,{class:"pa-2",cols:"12",md:"6"},{default:t(()=>[e(Vt,{school:s(u)},null,8,["school"])]),_:1}),e(i,{class:"pa-2",cols:"12",md:"6"},{default:t(()=>[e(Ot,{school:s(u)},null,8,["school"])]),_:1})]),_:1}),e(w,null,{default:t(()=>[e(i,{class:"pa-2",cols:"12",md:"6"},{default:t(()=>[e(Nt,{school:s(u)},null,8,["school"])]),_:1}),e(i,{class:"pa-2",cols:"12",md:"6"},{default:t(()=>[e(Et,{school:s(u)},null,8,["school"])]),_:1})]),_:1}),e(w,null,{default:t(()=>[e(i,{class:"pa-2",cols:"12"},{default:t(()=>[e(C,{title:"Note",elevation:"3"},{default:t(()=>[e(B,null,{default:t(()=>[(f(!0),H(ue,null,re(I.value,O=>(f(),U(S,{key:O.id},{default:t(()=>[e(g,null,{default:t(()=>[e(w,{"no-gutters":""},{default:t(()=>[e(i,{class:"d-flex justify-start",cols:"8"},{default:t(()=>[A(P(O.title),1)]),_:2},1024),e(i,{class:"text-grey",cols:"4"},{default:t(()=>[te("span",null,P(O.student),1)]),_:2},1024)]),_:2},1024)]),_:2},1024),e(T,null,{default:t(()=>[A(P(O.description),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["title"])):oe("",!0)}}});export{Zt as default};
