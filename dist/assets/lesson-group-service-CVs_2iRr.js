var E=Object.defineProperty;var q=(M,e,t)=>e in M?E(M,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):M[e]=t;var p=(M,e,t)=>q(M,typeof e!="symbol"?e+"":e,t);import{I,J as L,K as T,L as O}from"./index-CpIGLp9M.js";import{y as m,T as D,m as w,L as W}from"./model-D1ew20Fo.js";import{D as v,v as S,W as B}from"./school-service-CwQaC_z3.js";const g=class g{constructor(){p(this,"today")}static get instance(){return this._instance||(this._instance=new g),this._instance}calculateToday(){const e=new Date(new Date().toDateString()),t=m.fromDate(e);this.today={asDate:e,asString:t.toIyyyyMMdd(),asyyyyMMdd:t,asIyyyyMMdd:t.toIyyyyMMdd()}}async getCalendarLessons(e,t,a){const n=[],o=await v.instance.getDailyLessonOfSchoolBetweenDate(e,t.date.toIyyyyMMdd(),a.date.toIyyyyMMdd());n.push(...o.flatMap(f=>{const y=m.fromIyyyyMMdd(f.date).toIyyyyMMdd("-",1);return f.lessons.map(r=>({id:S(),title:r.studentId,start:y+" "+D.fromITime(r.startTime).format(),end:y+" "+D.fromITime(r.endTime).format(),data:{date:y}}))}));const d=I(L("schoolId"),"==",e),u=I(L("from"),"<=",a.date.toIyyyyMMdd()),i=I(L("to"),">=",t.date.toIyyyyMMdd()),c=await B.instance.getAll(d,u,i),s=a.date.toDate(),l=t.date.toDate();for(;l<=s&&c.length>0;)c.forEach(f=>{const y=T(l,f.dayOfWeek);if(y>s||y>m.fromIyyyyMMdd(f.to).toDate()||y<m.fromIyyyyMMdd(f.from).toDate())return;const r=m.fromDate(y).toIyyyyMMdd("-",1);n.find(h=>{var x;return((x=h.data)==null?void 0:x.date)==r})||n.push(...f.schedule.map(h=>({id:S(),title:h.studentId,start:r+" "+D.fromITime(h.startTime).format(),end:r+" "+D.fromITime(h.endTime).format()})))}),l.setDate(l.getDate()+7);return n}async getGroupedLessons(e){const t=[];return this.calculateToday(),await this.addLastLessons(e,t,2),this.addUpcomingLessons(e.dailyLessons,e.weeklyLessons,t,4),this.groupLessonsByMonth(t)}async addLastLessons(e,t,a){const n=e.dailyLessons,o=e.weeklyLessons,d=n.filter(s=>s.date<=this.today.asString);d.sort((s,l)=>l.date.localeCompare(s.date)),d.slice(0,a).reverse().forEach(s=>{t.push(this.createLessonProjection(s,!1))});const i=new Date,c=[...o];for(;t.length<a&&c.length>0;)c.forEach(async(s,l)=>{if(t.length>=a)return;const f=O(i,s.dayOfWeek),y=m.fromDate(f),r=y.toIyyyyMMdd();if(s.from>r||r>s.to){c.splice(l,1);return}s.exclude.includes(r)||t.some(h=>h.date.equals(y))||t.push({date:y,pending:!0,next:!1,lessons:s.schedule})}),i.setDate(i.getDate()-7)}addUpcomingLessons(e,t,a,n){const o=new Date,d=a.length+n,u=e.filter(s=>s.date>this.today.asString).sort((s,l)=>s.date.localeCompare(l.date));let i=0;const c=[...t];for(;(c.length>0||u.length>i)&&a.length<d;){if(c.length==0){const s=u[i];a.push(this.createLessonProjection(s,!1)),i++}c.forEach((s,l)=>{if(a.length>=d)return;const f=T(o,s.dayOfWeek),y=m.fromDate(f),r=y.toIyyyyMMdd();if(s.from>r||r>s.to){c.splice(l,1);return}for(;u.length>i&&u[i].date<=r&&a.length<d;){const h=u[i];a.push(this.createLessonProjection(h,!1)),i++}s.exclude.includes(r)||a.length<d&&!a.some(h=>h.date.equals(y))&&a.push({date:y,next:!1,lessons:s.schedule})}),o.setDate(o.getDate()+7)}}groupLessonsByMonth(e){const t=[];let a=!1;return e.sort((n,o)=>n.date.toIyyyyMMdd()>o.date.toIyyyyMMdd()?1:-1).forEach(n=>{const o=n.date.getMonth();let d=t.findIndex(u=>u.month==w[o]);d==-1&&(t.push({month:w[o],lessons:[]}),d=t.length-1),!a&&n.date.toDate()>=this.today.asDate&&(a=!0,n.next=!0),t[d].lessons.push(n)}),t}createLessonProjection(e,t){const a=e.date<=this.today.asString&&e.lessons.some(o=>o.status==W.NONE),n=e.lessons.some(o=>{var d;return((d=o.recovery)==null?void 0:d.ref)=="original"});return{dailyLessonId:e.id,date:m.fromIyyyyMMdd(e.date),recovery:n,pending:a,next:t,lessons:e.lessons}}};p(g,"_instance",null);let _=g;export{_ as L};
