var G=Object.defineProperty;var J=(n,t,e)=>t in n?G(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var _=(n,t,e)=>J(n,typeof t!="symbol"?t+"":t,e);import{U as g,$ as Q}from"./index-B7rqJQ63.js";import{A as C,u as V,D as W}from"./abstract-repository-DFRYPiFc.js";import{n as D,y as p,T as w,b as Y,p as R,m as F,L as X}from"./model-B-Fakfb5.js";const U=class U extends C{constructor(){super(V(W.STUDENTS))}static get instance(){return this._instance||(this._instance=new U),this._instance}};_(U,"_instance",null);let S=U;const q=class q{static get instance(){return this._instance||(this._instance=new q),this._instance}async getStudentsOfSchool(t){const e=g(D("schoolId"),"==",t);return S.instance.getAll(e)}observeStudentsOfSchool(t){const e=g(D("schoolId"),"==",t);return S.instance.observeAll(e)}async getStudentsOfSchoolWithIds(t,e){const s=g(D("schoolId"),"==",t),d=g(Q(),"in",e);return S.instance.getAll(s,d)}};_(q,"_instance",null);let H=q;const E=class E extends C{constructor(){super(V(W.WEEKLY_LESSONS))}static get instance(){return this._instance||(this._instance=new E),this._instance}};_(E,"_instance",null);let O=E;const v=class v extends C{constructor(){super(V(W.DAILY_LESSONS))}static get instance(){return this._instance||(this._instance=new v),this._instance}};_(v,"_instance",null);let N=v;var o=[];for(var A=0;A<256;++A)o.push((A+256).toString(16).slice(1));function Z(n,t=0){return(o[n[t+0]]+o[n[t+1]]+o[n[t+2]]+o[n[t+3]]+"-"+o[n[t+4]]+o[n[t+5]]+"-"+o[n[t+6]]+o[n[t+7]]+"-"+o[n[t+8]]+o[n[t+9]]+"-"+o[n[t+10]]+o[n[t+11]]+o[n[t+12]]+o[n[t+13]]+o[n[t+14]]+o[n[t+15]]).toLowerCase()}var T,k=new Uint8Array(16);function j(){if(!T&&(T=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!T))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return T(k)}var P=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);const K={randomUUID:P};function $(n,t,e){if(K.randomUUID&&!t&&!n)return K.randomUUID();n=n||{};var s=n.random||(n.rng||j)();return s[6]=s[6]&15|64,s[8]=s[8]&63|128,Z(s)}const b=class b{constructor(){_(this,"today")}static get instance(){return this._instance||(this._instance=new b),this._instance}calculateToday(){const t=new Date(new Date().toDateString()),e=p.fromDate(t);this.today={asDate:t,asString:e.toIyyyyMMdd(),asyyyyMMdd:e,asIyyyyMMdd:e.toIyyyyMMdd()}}async getCalendarLessons(t,e,s){const d=[],r=g(D("schoolId"),"==",t),c=g(D("date"),">=",e.date.toIyyyyMMdd()),l=g(D("date"),"<=",s.date.toIyyyyMMdd()),i=await N.instance.getAll(r,c,l);d.push(...i.flatMap(u=>{const M=p.fromIyyyyMMdd(u.date).toIyyyyMMdd("-",1);return u.lessons.map(I=>({id:$(),title:I.studentId,start:M+" "+w.fromITime(I.startTime).format(),end:M+" "+w.fromITime(I.endTime).format(),data:{date:M}}))}));const h=g(D("schoolId"),"==",t),a=g(D("from"),"<=",s.date.toIyyyyMMdd()),f=g(D("to"),">=",e.date.toIyyyyMMdd()),x=await O.instance.getAll(h,a,f),m=s.date.toDate(),y=e.date.toDate();for(;y<=m&&x.length>0;)x.forEach(u=>{const M=Y(y,u.dayOfWeek);if(M>m||M>p.fromIyyyyMMdd(u.to).toDate()||M<p.fromIyyyyMMdd(u.from).toDate())return;const I=p.fromDate(M).toIyyyyMMdd("-",1);d.find(L=>{var B;return((B=L.data)==null?void 0:B.date)==I})||d.push(...u.schedule.map(L=>({id:$(),title:L.studentId,start:I+" "+w.fromITime(L.startTime).format(),end:I+" "+w.fromITime(L.endTime).format()})))}),y.setDate(y.getDate()+7);return d}async getGroupedLessons(t){const e=[];return this.calculateToday(),await this.addLastLessons(t,e,2),this.addUpcomingLessons(t.dailyLessons,t.weeklyLessons,e,4),this.groupLessonsByMonth(e)}async addLastLessons(t,e,s){const d=t.dailyLessons,r=t.weeklyLessons,c=d.filter(a=>a.date<=this.today.asString);c.sort((a,f)=>f.date.localeCompare(a.date)),c.slice(0,s).reverse().forEach(a=>{e.push(this.createLessonProjection(a,!1))});const i=new Date,h=[...r];for(;e.length<s&&h.length>0;)h.forEach(async(a,f)=>{if(e.length>=s)return;const x=R(i,a.dayOfWeek),m=p.fromDate(x),y=m.toIyyyyMMdd();if(a.from>y||y>a.to){h.splice(f,1);return}a.exclude.includes(y)||e.some(u=>u.date.equals(m))||e.push({date:m,pending:!0,next:!1,lessons:a.schedule})}),i.setDate(i.getDate()-7)}addUpcomingLessons(t,e,s,d){const r=new Date,c=s.length+d,l=t.filter(a=>a.date>this.today.asString).sort((a,f)=>a.date.localeCompare(f.date));let i=0;const h=[...e];for(;(h.length>0||l.length>i)&&s.length<c;){if(h.length==0){const a=l[i];s.push(this.createLessonProjection(a,!1)),i++}h.forEach((a,f)=>{if(s.length>=c)return;const x=Y(r,a.dayOfWeek),m=p.fromDate(x),y=m.toIyyyyMMdd();if(a.from>y||y>a.to){h.splice(f,1);return}for(;l.length>i&&l[i].date<=y&&s.length<c;){const u=l[i];s.push(this.createLessonProjection(u,!1)),i++}a.exclude.includes(y)||s.length<c&&!s.some(u=>u.date.equals(m))&&s.push({date:m,next:!1,lessons:a.schedule})}),r.setDate(r.getDate()+7)}}groupLessonsByMonth(t){const e=[];let s=!1;return t.sort((d,r)=>d.date.toIyyyyMMdd()>r.date.toIyyyyMMdd()?1:-1).forEach(d=>{const r=d.date.getMonth();let c=e.findIndex(l=>l.month==F[r]);c==-1&&(e.push({month:F[r],lessons:[]}),c=e.length-1),!s&&d.date.toDate()>=this.today.asDate&&(s=!0,d.next=!0),e[c].lessons.push(d)}),e}createLessonProjection(t,e){const s=t.date<=this.today.asString&&t.lessons.some(r=>r.status==X.NONE),d=t.lessons.some(r=>{var c;return((c=r.recovery)==null?void 0:c.ref)=="original"});return{dailyLessonId:t.id,date:p.fromIyyyyMMdd(t.date),recovery:d,pending:s,next:e,lessons:t.lessons}}};_(b,"_instance",null);let z=b;export{N as D,z as L,S,O as W,H as a,$ as v};
